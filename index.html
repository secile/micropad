<!DOCTYPE html>
<meta charset="UTF-8">
<title>micro:pad</title>

<style type="text/css">
* {
    font-size: 3vmin;
}
</style>

<body>
    <div style="position:absolute; left:10px; top:10px;">
        <button type="button" id="connect"    onclick="connectBLE()">ðŸš©</button>
        <button type="button" id="disconnect" onclick="disconnectBLE()" disabled>ðŸ›‘</button>
    </div>
    <canvas id="canvas"></canvas>
</body>

<script>

//--- connect with microbit via bluetooth.
let isConnected = false;
let uBitDevice;
let rxCharacteristic;

async function connectBLE() {
    const UART_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const UART_TX_CHARACTERISTIC_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
    const UART_RX_CHARACTERISTIC_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

    if (isConnected) return;

    try {
        console.log("Requesting Bluetooth Device...");
        uBitDevice = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: "BBC micro:bit" }],
            optionalServices: [UART_SERVICE_UUID]
        });

        uBitDevice.addEventListener('gattserverdisconnected', onDisconnected);

        console.log("Connecting to GATT Server...");
        const server = await uBitDevice.gatt.connect();

        console.log("Getting Service...");
        const service = await server.getPrimaryService(UART_SERVICE_UUID);

        console.log("Getting Characteristics...");
        const txCharacteristic = await service.getCharacteristic(UART_TX_CHARACTERISTIC_UUID);
        txCharacteristic.startNotifications();
        txCharacteristic.addEventListener("characteristicvaluechanged", onTxCharacteristicValueChanged);
        rxCharacteristic = await service.getCharacteristic(UART_RX_CHARACTERISTIC_UUID);

        isConnected = true;
        document.getElementById('connect').disabled = true;
        document.getElementById('disconnect').disabled = false;
        console.log("Connected");
    } catch (error) {
        console.log(error);
    }
}

function disconnectBLE() {
    if (!uBitDevice) return;
    
    if (uBitDevice.gatt.connected) {
    uBitDevice.gatt.disconnect();
  }
}

// called when disconnected.
function onDisconnected(event) {
    let device = event.target;
    console.log(`Device ${device.name} is disconnected.`);
    isConnected = false;
    document.getElementById('connect').disabled = false;
    document.getElementById('disconnect').disabled = true;
    console.log("Disconnected");
}

// send cmd and micro:bit receive data.
async function sendCmd(num) {
    if (!rxCharacteristic) return;
    
    let encoder = new TextEncoder();
    enqueue(() => rxCharacteristic.writeValue(encoder.encode(num + "\n"))
        .catch(error => console.error('error occured while writeValue:', error)));
}

let queue = Promise.resolve();

function enqueue(operation) {
   queue = queue.then(operation, operation);
   return queue;
}

// called when micro:bit send data.
function onTxCharacteristicValueChanged(event) {
	let receivedData = [];
	for (var i = 0; i < event.target.value.byteLength; i++) {
		receivedData[i] = event.target.value.getUint8(i);
	}

	const receivedString = String.fromCharCode.apply(null, receivedData);
	console.log(receivedString);
}

//--- user interface.
let canvas, context;

setup();

// start animation.
requestAnimationFrame(updateFrame);

window.addEventListener('resize', () => setup());

function setup() {
    canvas = document.querySelector('#canvas');
    context = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

function update() {
    console.log("update");
}

function draw() {    
    // clear screen.
    context.clearRect(0, 0, canvas.width, canvas.height);
    canvas.style.backgroundColor = "AliceBlue";
}

// update frame.
function updateFrame() {
    update();
    draw();
    requestAnimationFrame(updateFrame);
}

</script>
